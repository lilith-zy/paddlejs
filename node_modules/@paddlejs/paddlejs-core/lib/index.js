!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.paddlejsCore=e():t.paddlejsCore=e()}(this,(function(){return(()=>{var t={911:(t,e)=>{"use strict";var n=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n)return n;throw new Error("unable to locate global object")}();t.exports=e=n.fetch,n.fetch&&(e.default=n.fetch.bind(n)),e.Headers=n.Headers,e.Request=n.Request,e.Response=n.Response},180:(t,e,n)=>{"use strict";n.r(e),n.d(e,{PaddlejsBackend:()=>H,Runner:()=>B,Transformer:()=>f,env:()=>i,interfaces:()=>r,registerBackend:()=>h});var r={};n.r(r),n.d(r,{GraphType:()=>s});const i=function(){function t(){}return t.set=function(e,n){t.ENV||(t.ENV=new t),t.ENV[e]=n},t.get=function(e){return t.ENV||(t.ENV=new t),t.ENV[e]},t}();const a=function(){function t(t,e){void 0===e&&(e=1),this.urlConf={dir:"",main:""},this.multipart=!1,this.chunkNum=0,this.dataType="binary",this.params={type:"fetch"},this.inNode=!1,this.isLocalFile=!1,this.realFetch=function(){throw new Error("ERROR: empty fetch funciton")};var n="",r="model.json";if(t.endsWith(".json")){var a=t.lastIndexOf("/")+1;n=t.substr(0,a),r=t.substr(a)}else"/"!==t.charAt(t.length-1)&&(n=t+"/");this.isLocalFile=0!==n.indexOf("http"),this.urlConf={dir:this.isLocalFile?"/"===n.charAt(0)?""+n:"/"+n:n,main:r},this.multipart=e>0,this.dataType="binary",this.chunkNum=e,this.inNode="node"===i.get("platform")}return t.prototype.load=function(){return t=this,e=void 0,r=function(){var t,e=this;return function(t,e){var n,r,i,a,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}(this,(function(n){switch(n.label){case 0:return[4,this.fetchModel()];case 1:return t=n.sent(),!0!==this.multipart||"binary"!==this.dataType?[3,3]:[4,this.fetchChunks().then((function(n){return e.traverse(t.vars,n)}))];case 2:n.sent(),n.label=3;case 3:return[2,t]}}))},new((n=void 0)||(n=Promise))((function(i,a){function s(t){try{u(r.next(t))}catch(t){a(t)}}function o(t){try{u(r.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,o)}u((r=r.apply(t,e||[])).next())}));var t,e,n,r},t.prototype.fetchOneChunk=function(t){return this.fetch(t).then((function(t){return t.arrayBuffer()}))},t.prototype.fetchJson=function(t){return this.fetch(t).then((function(t){return t.json()}))},t.prototype.getFileName=function(t){return"chunk_"+t+".dat"},t.prototype.fetchChunks=function(){for(var t=this.chunkNum,e=[],n=1;n<=t;n++)e.push(this.fetchOneChunk(this.urlConf.dir+this.getFileName(n)));return Promise.all(e).then((function(t){var e,n=0,r=[];t.forEach((function(t){e=new Float32Array(t),r.push(e),n+=e.length}));var i=new Float32Array(n),a=0;return r.forEach((function(t){t.forEach((function(t){i[a]=t,a+=1}))})),i}))},t.prototype.traverse=function(t,e){var n,r=0;t.filter((function(t){return t.name})).forEach((function(t){n=t.shape.reduce((function(t,e){return t*e})),t.persistable&&(t.data=e.slice(r,r+n),r+=n)}))},t.prototype.fetch=function(t,e){var r=(e||this.params).method||"get",i=new(this.inNode?n(911).Headers:Headers);return this.realFetch=this.inNode?this.isLocalFile?this.fetchLocalFile:n(911):window.fetch.bind(window),this.realFetch(t,{method:r,headers:i})},t.prototype.fetchLocalFile=function(t){var e=n(993);return new Promise((function(n,r){try{n(e.readFileSync(t,"utf8"))}catch(t){r(t)}}))},t.prototype.fetchModel=function(){var t=this,e=this.params,n=this.urlConf.dir+this.urlConf.main,r=null;return"fetch"===e.type&&(r=new Promise((function(r,i){t.fetch(n,e).then((function(e){return t.isLocalFile&&t.inNode?JSON.parse(e):e.json()})).then((function(t){return r(t)})).then((function(t){return i(t)}))}))),r},t}();var s;!function(t){t.SingleOutput="single",t.MultipleOutput="multiple",t.MultipleInput="multipleInput"}(s||(s={}));var o,u={opRegistry:{ops:{}},backend:"",backendInstance:null};function h(t,e,n){t&&(u.backend=t),e&&(u.backendInstance=e),n&&Object.keys(n).forEach((function(t){!function(t,e){var n=t.conf,r=t.params,i=t.main,a=t.main_packed,s=void 0===a?"":a,o=t.behaviors,h=void 0===o?[]:o,p=u.backend+"_"+e;u.opRegistry.ops[p]||(u.opRegistry.ops[p]={name:e,conf:n,params:r,main:i,main_packed:s,behaviors:h})}(n[t],t)}))}function p(){var t;if("undefined"!=typeof window)t=window;else if(void 0!==n.g)t=n.g;else{if("undefined"==typeof self)throw new Error("Could not find a global object");t=self}return t}(o=p()).GLOBALS||(o.GLOBALS=u),u=o.GLOBALS;const c=function(){function t(t,e,n){void 0===n&&(n=!1),this.id="",this.type="",this.inputs={},this.outputs={},this.attrs={},this.subAttrs=[],this.next=null,this.opData=null,this.isPacked=!1,this.finish=!1;var r=t.inputs,i=t.outputs,a=t.attrs,s=void 0===a?{}:a,o=t.type;this.id=o+"_"+ +new Date+"_"+e,this.inputs=r,this.outputs=i,this.attrs=s,this.subAttrs=t["sub-attrs"]||[],this.type=o,this.isPacked=n||!1,this.finish=!1,this.next=null,this.opData=null,this.isPacked=!1}return Object.defineProperty(t.prototype,"inputsName",{get:function(){var t=this,e=[];return Object.keys(this.inputs).forEach((function(n){e.push(t.inputs[n][0])})),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"outputsName",{get:function(){return this.outputs.Output||this.outputs.Out||this.outputs.Y},enumerable:!1,configurable:!0}),t.prototype.execute=function(t){"feed"!==this.type&&u.backendInstance.runProgram(this.opData,t)},t}(),f=function(t){this.name=t};var l,d=(l=function(t,e){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),g={conv2d:function(t,e){var n=t.attrs.strides,r=t.inputs.Input[0],i=t.inputs.Filter[0];if("image"===r)return!1;var a=e.find((function(t){return t.name===r})).shape,s=e.find((function(t){return t.name===i})).shape;return!n.find((function(t){return t>1}))&&a[a.length-1-2]%4==0&&4===s.length&&s[0]%4==0&&s[1]%4==0}};function v(t){return{type:"packed_2_unpacked",attrs:{},inputs:{Input:[t.inputName]},outputs:{Output:[t.outputName]}}}function m(t){return{type:"unpacked_2_packed",attrs:{},inputs:{Input:[t.inputName]},outputs:{Output:[t.outputName]}}}function y(t,e){Object.keys(t.inputs).forEach((function(e){t.inputs[e]=[t.inputs[e]+"_packed"]})),Object.keys(t.outputs).forEach((function(e){t.outputs[e]=[t.outputs[e]+"_packed"]})),t.id=t.type+"_"+ +new Date+"_"+e.length,t.isPacked=!0}const b=function(t){function e(){return t.call(this,"TexturePacking")||this}return d(e,t),e.prototype.transform=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t[0],r=t[1],i=t[2];if(g[n.type]&&g[n.type](n,r)){var a=n.inputsName,s=n.outputsName,o=m({inputName:a[0],outputName:a[0]+"_packed"}),u=i.length;i.push(new c(o,u)),y(n,i);var h=v({inputName:s[0]+"_packed",outputName:s[0]}),p=i.length+1;i.push(new c(h,p))}},e}(f);var w=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();const _=function(t){function e(){return t.call(this,"FormatInputsX")||this}return w(e,t),e.prototype.transform=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t[0];if("concat"===n.type||"connect"===n.type){var r=n.inputs;if(r.X.length>4)throw Error("Not yet supporting concat input tensors more than 4.");if(r.X.length>1){var i=r.X,a=i[0],s=i[1],o=i[2],u=i[3];r.X=[a],s&&(r.Y=[s]),o&&(r.Z=[o],n.type+="_mul"),u&&(r.M=[u])}}},e}(f);var x=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),O=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var a=arguments[e],s=0,o=a.length;s<o;s++,i++)r[i]=a[s];return r};function P(t,e){var n=e.filter((function(e){return e.name===t}));return n.length?n[0].shape:[]}function k(t,e,n,r){for(var i=O(e),a=0,s=0,o=t;s<o.length;s++)a+=P(o[s],r)[n];return i[n]=a,{name:t[t.length-1]+"_out",shape:i}}var T={preTransforms:[new(function(t){function e(){return t.call(this,"splitOp")||this}return x(e,t),e.prototype.transform=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];for(var r=e[0],i=e[1],a=0,s=r.length;a<s;a++){var o=r[a];if("concat"===o.type&&(null===(t=o.inputs)||void 0===t?void 0:t.X)&&!(o.inputs.X.length<=4)){var u=o.attrs,h=o.inputs,p=o.outputs,c=h.X,f=c.length,l=Math.ceil((f-4)/3)+1,d=p.Out[0],g=P(d,i),v=u.axis||0;v=v>-1?v:g.length+v;for(var m=[],y=[],b=c.slice(0,4),w=void 0,_=0;_<l;_++){var x=0===_?b:c.slice(3*_+1,3*(_+1)+1),T=k(x,g,v,i);0!==_&&x.splice(0,0,w.name),T.shape[v]+=w?w.shape[v]:0;var N={Out:[T.name]};y.push({attrs:u,inputs:{X:x},outputs:N,type:"concat"}),m.push(T),w=T}y[l-1].outputs.Out=[d],r.splice.apply(r,O([a,1],y)),i.splice.apply(i,O([i.length-1,0],m))}}},e}(f))],transforms:[new _],postTransforms:[]};"webgl"===u.backend&&T.transforms.splice(1,0,new b);const N=T;var S,E=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var a=arguments[e],s=0,o=a.length;s<o;s++,i++)r[i]=a[s];return r};function M(t,e){return t&&t[e]||[]}!function(t){t.PreTransforms="preTransforms",t.Transforms="transforms",t.PostTransforms="postTransforms"}(S||(S={}));const j=function(){function t(t,e,n){this.weightMap=[],this.ops=[],this.vars=[],this.type=s.SingleOutput,this.plugins=null,this.ops=t.ops,this.vars=t.vars,this.type=e||this.type,this.plugins=n}return t.prototype.createGraph=function(){return this.preTransforms(),this.createOpsMap(),this.constructOpsMap(),this.arrangeMap(),this.postTransforms(),this.weightMap},t.prototype.preTransforms=function(){var t=this;E(N.preTransforms,M(this.plugins,S.PreTransforms)).forEach((function(e){e.transform(t.ops,t.vars,t.type)}))},t.prototype.transforms=function(t,e){var n=this;E(N.transforms,M(this.plugins,S.Transforms)).forEach((function(r){r.transform(t,n.vars,e)}))},t.prototype.postTransforms=function(){var t=this;E(N.postTransforms,M(this.plugins,S.PostTransforms)).forEach((function(e){e.transform(t.weightMap,t.vars,t.type)}))},t.prototype.createOpsMap=function(){for(var t=[],e=0;e<this.ops.length;e++){var n=t.length,r=this.ops[e],i=new c(r,n);this.transforms(i,t),t.push(i)}this.weightMap=t},t.prototype.constructOpsMap=function(){for(var t=0;t<this.weightMap.length;t++){var e=this.weightMap[t],n=e.outputsName[0],r=this.getNextExecutor(this.weightMap,n);r&&(e.next=r.id)}},t.prototype.arrangeMap=function(){for(var t={},e=[],n={},r=0;r<this.weightMap.length;r++)for(var i=this.weightMap[r],a=0;a<i.outputsName.length;a++){var s=i.outputsName[a];t[s]=!0}var o=function(r){var i=u.weightMap[r];e[r]=0,n[i.id]=r,i.inputsName.length>1?i.inputsName.forEach((function(n){!0===t[n]&&e[r]++})):e[r]=i.inputsName.length},u=this;for(r=0;r<this.weightMap.length;r++)o(r);this.topoSort(this.weightMap,e,n)},t.prototype.topoSort=function(t,e,n){var r=[];r.push(t[0]);for(var i=t.slice(0),a=null,s=t[0];r.length>0;){null!=a&&(t[n[a.id]].next=s.id),a=s,s=r.pop()||{};for(var o=0;o<s.outputsName.length;o++)for(var u=0;u<i.length;u++)for(var h=0;h<i[u].inputsName.length;h++)if(i[u].inputsName[h]===s.outputsName[o]&&(e[n[i[u].id]]--,0===e[n[i[u].id]])){r.push(t[n[i[u].id]]),i.splice(u,1),u--;break}}},t.prototype.getNextExecutor=function(t,e){return t.find((function(t){if(!t.next)for(var n=0;n<t.inputsName.length;n++)if(e===t.inputsName[n])return!0;return!1}))},t.prototype.getFeedExecutor=function(){return this.weightMap.find((function(t){return"feed"===t.type}))},t.prototype.getFetchExecutor=function(){return this.weightMap.find((function(t){return"fetch"===t.type}))},t.prototype.getExecutorById=function(t){return this.weightMap.find((function(e){return e.id===t}))},t}();var F=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var a=arguments[e],s=0,o=a.length;s<o;s++,i++)r[i]=a[s];return r};function C(t){if(t.length<4){for(var e=[],n=0;n<4-t.length;n++)e.push(1);return e.concat(t)}return F(t)}function A(t){return t.reduce((function(t,e){return t*e}))}function D(t,e){var n=t.length;return 4-n+(e>-1?e:n+e)}const I=function(){function t(t){this.opts={},this.isPacked=!1,this.name="",this.tensorId="",this.total=1,this.shape=[],this.unformattedShapeLength=0,this.shape_texture=[],this.exceedMax=!1,this.data=null,this.opts=t,this.isPacked=t.isPacked||!1,this.name=t.name,this.tensorId=t.type,this.unformattedShapeLength=t.shape.length,this.shape=C(t.shape);var e=this.shape;if(this.total=e.reduce((function(t,e){return t*e})),!t.noLayout){var n=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=!1);var n=u.backendInstance.MAX_TEXTURE_SIZE||4096,r=t[0],i=t[1],a=t[2],s=t[3],o=r*a,h=i*s,p=!1;if(e)return{exceedMax:p,shape:[4,o,h],packedShape:[r,i,a,s],packedTextureShape:[4,o,i*s],zeroNumber:o*i*s*4-o*h};if((o>n||h>n)&&(console.error("大小超限",t),o*=4,h=i*Math.ceil(s/4),p=!0,o>n||h>n))throw new Error("Requested texture size ["+h+"x"+o+"] greater than WebGL maximum on this browser / GPU ["+n+"x"+n+"].");return{exceedMax:p,shape:[4,o,h],zeroNumber:0}}(e,t.isPacked),r=n.exceedMax,i=n.shape;if(this.shape_texture=i,this.exceedMax=r,t.type.endsWith("image"))this.data=t.data;else if(t.data&&t.data.length){var a=function(t,e){for(var n=e[0],r=e[1],i=e[2],a=e[3],s=i*a,o=r*i*a,u=[],h=0;h<n;h++)for(var p=0;p<i;p++)for(var c=0;c<a;c++)for(var f=0;f<r;f++)u.push(t[h*o+f*s+p*a+c]);return u}(t.data,[e[0],e[1]*(this.isPacked?4:1),e[2],e[3]]);this.data=new Float32Array(a),t.data=null}}}return Object.defineProperty(t.prototype,"width_texture",{get:function(){var t=this.shape_texture.length;return this.shape_texture[t-1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height_texture",{get:function(){var t=this.shape_texture.length;return this.shape_texture[t-2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width_shape",{get:function(){var t=this.shape.length;return this.shape[t-1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height_shape",{get:function(){var t=this.shape.length;return this.shape[t-2]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"channel",{get:function(){var t=this.shape.length;return this.shape[t-3]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"binding",{get:function(){return this.opts.binding},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"limit",{get:function(){return this.exceedMax?"Limit":""},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length_shape",{get:function(){return this.shape.length||0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length_unformatted_shape",{get:function(){return this.unformattedShapeLength||0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"total_shape",{get:function(){return this.total},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"numbers_shape",{get:function(){for(var t=[],e=this.shape.length,n=0;n<e-1;n++){var r=this.shape.slice(n+1).reduce((function(t,e){return t*e}));t.push(r)}return t.push(1),t},enumerable:!1,configurable:!0}),t}(),L={adaptPaddings:function(){for(var t in this.attrs)if(Object.prototype.hasOwnProperty.call(this.attrs,t)&&"paddings"===t){var e=this.attrs[t],n=e[0],r=e[1];return void(0===n&&1===r&&(this.attrs[t][1]=0))}},isGlobalPooling:function(){var t=this.input.X[0]||{},e=t.shape&&t.shape.length||0;e>2&&this.attrs.global_pooling&&(this.attrs.ksize=[t.shape[e-2],t.shape[e-1]])},setPacked:function(t){var e=this;void 0===t&&(t=[]);var n=this.attrs.ispacked;t.forEach((function(t){"origin"===t.tensorName&&n&&(t.isPacked=!0,e.name.indexOf("pool")>-1&&(e.name+="_winograd"))}))},mergeAttrs:function(){this.attrs=this.subAttrs.reduce((function(t,e){return Object.assign(t,e)}),{})},isApplySeparableConv:function(t){if(void 0===t&&(t=[]),!this.isPackedOp){var e=this.attrs.groups,n=t.filter((function(t){var n=t.shape,r=t.tensorName,i=n[0],a=n[1];return i===e&&1===a&&"filter"===r}));"depthwise_conv2d"===this.name&&(this.name="conv2d"),n&&n.length&&(this.name+="_depthwise")}},batchComputeConv2d:function(){try{var t=this.input.Filter[0].shape[1];this.attrs.filter_nearest_vec4=4*Math.floor(t/4),this.attrs.filter_remainder_vec4=t%4}catch(t){console.error(t)}},processBias:function(t){void 0===t&&(t=[]);var e=t.find((function(t){return"bias"===t.tensorName}));if(e&&this.isPackedOp){e.packed=!0;var n=e.shape,r=[n[n.length-1]/4,1,1];e.shape=r}else if(!e){var i=t.find((function(t){return"out"===t.tensorName})).shape,a=i[i.length-3],s=this.isPackedOp?[a,1,1]:[a],o=this.isPackedOp?4*a:a;t.push({name:"conv1_scale_offset_custom",packed:this.isPackedOp,needBatch:!0,persistable:!0,shape:s,data:Array.from(new Float32Array(o),(function(){return 0})),tensorName:"bias"})}},isMax:function(){var t="max"===this.attrs.pooling_type?1:0;this.attrs.pooling_type=t,1===t&&(this.name+="_max")},transToPrelu:function(){this.data.multi_value="0.0",this.data.active_function="prelu"},transToRelu6:function(){this.data.multi_value=this.attrs.threshold,this.data.active_function="relu6"},transToHardSigmoid:function(){this.data.multi_value=this.attrs.slope||.2,this.data.bias_value=this.attrs.offset||.5,this.data.active_function="hardSigmoid"},transToLeakyrelu:function(){this.data.multi_value=this.attrs.alpha,this.data.active_function="leakyRelu",this.name="relu"},transToPow:function(){this.data.multi_value=this.attrs.factor||2,this.data.active_function="pow",this.name="pow"},transToSigmoid:function(){this.data.active_function="sigmoid"},transToScale:function(){var t=this.attrs.scale;this.data.multi_value=void 0!==t?t:1,this.data.bias_value=this.attrs.bias||0;var e=this.attrs.bias_after_scale;this.data.active_function=e||void 0===e?"scale":"scaleWidthBias"},setActiveFunc:function(){var t=this.realName.replace("conv2d-elementwise_add-","");this.data=Object.assign({active_function:"scale",multi_value:"1.0",bias_value:"0.0",fuse_relu:!1},this.data),"leaky_relu"===t&&(this.data.multi_value=this.attrs.alpha,this.data.active_function="leakyRelu")},normalizeDim:function(){for(var t=this.input.X[0].shape,e=C(t),n=D(t,this.attrs.axis),r=[],i=0;i<e[n];i++)r[i]=i;if(this.attrs.target_length=r.length,this.attrs.target_value=r,this.attrs.inputs_dim=e[n],this.attrs.dim=n,this.input.Y){var a=C(this.input.Y[0].shape);this.attrs.append_num=a[n]}if(this.input.M){this.attrs.fourInputs=!0;var s=C(this.input.M[0].shape);this.attrs.fourth_num=s[n]}},processAxis:function(){var t=this.input.X[0].shape,e=this.input.Y[0].shape,n=this.attrs.axis||-1;this.attrs.counterLen=e.length,A(t)===A(e)?(this.attrs.axis=0,this.attrs.counterLen=4):(-1===n&&(n=t.length-e.length),this.attrs.axis=D(t,n))},genElementwiseCounterPos:function(){for(var t=this.attrs,e=t.counterLen,n=["0","0","0","0"],r=t.axis,i=4-e;i<4;i++)n[i]="oPos["+r+++"]";this.attrs.counterPos=n.join(",")},flattenShape:function(t){void 0===t&&(t=[]);var e=t.find((function(t){return t.shape.length>2}));if(e){var n=C(e.shape);e.shape=[n[0]*n[2],n[1]*n[3]]}},reshape:function(t){void 0===t&&(t=[]);var e=t.find((function(t){return"origin"===t.tensorName})),n=t.find((function(t){return"counter"===t.tensorName})),r=t.find((function(t){return"out"===t.tensorName||"output"===t.tensorName}));if(n.shape.length>e.shape.length){var i=n;n=e,e=i}if(e.shape.length>2&&2===n.shape.length){var a=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]);var n=t.reduce((function(t,e){return t*e}));return 1===e.length?[1,n]:[e[0],n/e[0]]}(e.shape,r.shape);e.shape=a}},checkIsMerge:function(){var t=this.realName.replace("conv2d-elementwise_add-","");this.name="conv2d_elementwise_add","leaky_relu"===t&&(this.data.multi_value=this.attrs.alpha,this.data.active_function="leakyRelu")}};var R=function(){return(R=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};const G=function(){function t(t,e,n,r,i){this.name="",this.realName="",this.isPackedOp=!1,this.input={},this.output={},this.data={},this.attrs={},this.subAttrs=[],this.inputTensors=[],this.outputTensors=[],this.fShaderParams=[],this.vars=[],this.iLayer=0,this.program=[],this.renderData=[],this.tensorData=[],this.isFinalOp=!1;var a=t.type,s=t.inputs,o=t.outputs,u=t.attrs,h=t.isPacked;this.modelName=i,this.attrs=u,this.subAttrs=t.subAttrs,this.name=a,this.realName=a,this.isPackedOp=h,this.vars=n,this.iLayer=e,this.isFinalOp=r,this.input=s,this.output=o,this.inputTensors=[],this.outputTensors=[],this.fShaderParams=[],this.program=[],this.renderData=[],this.constructTensorData(),this.buildTensor(),this.buildShaderParams(),this.buildProgram()}return t.prototype.constructTensorData=function(){var t=this;Object.keys(this.output).forEach((function(e){t.output[e].forEach((function(n,r){t.output[e][r]=t.getTensorVar(n)[0]}))})),Object.keys(this.input).forEach((function(e){t.input[e]=t.getTensorVar(t.input[e][0])}));var e=function(e){if(Object.prototype.hasOwnProperty.call(n.output,e))try{var r=n.output[e]||[{}],i=n.getExactTensorName(e,"output");i&&r.forEach((function(e,n){e.tensorName=i,t.tensorData.push(R(R({},e),{tensorName:i,runtime:n}))}))}catch(t){console.error(t)}},n=this;for(var r in this.output)e(r);for(var r in this.input)if(Object.prototype.hasOwnProperty.call(this.input,r)){var i=this.input[r].length>0?this.input[r]:[{}],a=this.getExactTensorName(r,"input");if(a){var s=i[0];s.tensorName=a,this.tensorData.push(R(R({},s),{tensorName:a}))}}},t.prototype.getExactTensorName=function(t,e){return"input"===e?{input:"origin",x:"origin",filter:"filter",y:"counter",z:"appender",m:"fourth",scale:"scale",bias:"bias",mean:"mean",variance:"variance",w:"weight"}[t.toLowerCase()]||t.toLowerCase():{output:"out",y:"out",out:"out",scale:"scale",bias:"bias",mean:"mean",variance:"variance"}[t.toLowerCase()]},t.prototype.getTensorVar=function(t){var e=this.vars.filter((function(e){return e.name===t||e.name===t.replace(/_packed$/,"")}));return e.length>0&&t.endsWith("_packed")?[function(t,e){var n=3===t.shape.length?F([1],t.shape):t.shape,r=n[0],i=n[1],a=n[2],s=n[3],o=Object.assign({},t);if(o.name=e,o.packed=!1,i%4==0){var u=i/4;o.packed=!0,o.shape=[r,u,a,s]}return o}(e[0],t)]:e},t.prototype.buildProgram=function(){var t=this,e=this.name,n=this.inputTensors;this.program=this.outputTensors.map((function(r,i){return u.backendInstance.createProgram({name:e,outTensor:r,inputTensors:n,shaderParams:t.fShaderParams[i],runtime:i,isPacked:t.isPackedOp||!1})}))},t.prototype.processTensorDataAndAttrs=function(){var t=this;try{this.name.indexOf("conv2d-elementwise_add")>-1&&(this.name="conv2d_elementwise_add"),this.name.indexOf("flatten2")>-1&&(this.name="reshape2");var e=this.tensorData,n=u.backend+"_"+this.name;(u.opRegistry.ops[n]&&u.opRegistry.ops[n].behaviors||[]).forEach((function(n){L[n].call(t,e)}))}catch(t){console.error(t)}},t.prototype.buildTensor=function(){var t=this;this.processTensorDataAndAttrs(),this.tensorData.forEach((function(e,n){var r,i=e.tensorName,a=new I({type:t.modelName+"_"+e.name,name:i,shape:e.shape,data:e.data||null,isPacked:t.isPackedOp||!1,binding:n,noLayout:null===(r=u.backendInstance)||void 0===r?void 0:r.noLayout});"out"===i?t.outputTensors.push(a):t.inputTensors.push(a),e.shape=a.shape,e.total=a.total}))},t.prototype.buildShaderParams=function(){var t=this,e=["length_shape","length_unformatted_shape","width_shape","height_shape","width_texture","height_texture","limit","channel","total_shape","binding"];for(var n in this.attrs)if(Object.prototype.hasOwnProperty.call(this.attrs,n)){var r=this.attrs[n];this.data[n]=r}this.inputTensors.forEach((function(n){e.forEach((function(e){t.data[e+"_"+n.name]=n[e]}))})),this.outputTensors.forEach((function(n){var r=JSON.parse(JSON.stringify(t.data));e.forEach((function(t){r[t+"_"+n.name]=n[t]})),t.fShaderParams.push(r)}))},t}(),z=function(){function t(){this.targetContext={},this.gapFillWith="#000",this.mean=[0,0,0],this.std=[1,1,1],this.bgr=!1,this.result=[],this.pixelWidth=224,this.pixelHeight=224,this.inputFeed=[];var t=document.createElement("canvas");this.targetContext=t.getContext("2d")}return t.prototype.process=function(t,e){var n=e.feedShape,r=e.fill,i=e.targetSize,a=e.scale,s=e.mean,o=e.std,u=e.bgr,h=n.fh,p=n.fw,c=t,f={gapFillWith:r||this.gapFillWith,mean:s||this.mean,std:o||this.std,bgr:u||this.bgr,scale:a,targetSize:i,targetShape:[1,3,h,p]};if(0===this.result.length){var l=f.targetShape,d=l[1],g=l[2],v=l[3];this.result=new Float32Array(g*v*d)}return this.fromPixels(c,f)||[]},t.prototype.fromPixels=function(t,e){var n,r=[];return t instanceof HTMLImageElement||t instanceof HTMLVideoElement?(this.pixelWidth=t.width,this.pixelHeight=t.height,e.scale&&e.targetSize?r=this.resizeAndFitTargetSize(t,e):e.targetSize?(n=this.fitToTargetSize(t,e),r=this.getImageData(0,0,n)):(n=this.reSize(t,e),r=this.getImageData(0,0,n)),e.gray&&(r=this.grayscale(r)),e.reShape&&(r=this.reshape(r,e,n)),e.bgr?r=this.allReshapeToBGR(r,e):e.targetShape&&(r=this.allReshapeToRGB(r,e)),[{data:r,shape:e.targetShape||e.shape,name:"image"}]):[{data:r,shape:e.shape||e.targetShape,name:"image"}]},t.prototype.reshape=function(t,e,n){for(var r=n.sw,i=n.sh,a=e.width,s=e.height,o=Math.ceil((r-a)/2),u=Math.ceil((i-s)/2),h=t.data,p=[],c=[],f=[],l=e.mean,d=e.std,g=0;g<h.length;g+=4){var v=g/4,m=Math.floor(v/r),y=v-m*r-1;y>=o&&y<o+a&&m>=u&&m<u+s&&(p.push((h[g]/255-l[0])/d[0]),c.push((h[g+1]/255-l[1])/d[1]),f.push((h[g+2]/255-l[2])/d[2]))}return p.concat(c.concat(f))},t.prototype.allReshapeToRGB=function(t,e){for(var n=e.mean,r=e.std,i=e.normalizeType,a=void 0===i?0:i,s=e.targetShape,o=s[1],u=s[2],h=s[3],p=t.data||t,c=this.result,f=0,l=0;l<u;++l)for(var d=l*h,g=0;g<h;++g)for(var v=d+g,m=0;m<o;++m){var y=4*v+m;c[f]=0===a?p[y]/255:(p[y]-128)/128,c[f]-=n[m],c[f]/=r[m],f++}return c},t.prototype.allReshapeToBGR=function(t,e){for(var n=e.targetShape,r=n[1],i=n[2],a=n[3],s=t.data||t,o=e.mean,u=e.std,h=this.result,p=0,c=0;c<i;++c)for(var f=c*a,l=0;l<a;++l)for(var d=f+l,g=0;g<r;++g){var v=4*d+(2-g);h[p]=s[v],h[p]-=o[2-g],h[p]/=u[2-g],p++}return h},t.prototype.reSize=function(t,e){var n=this.pixelWidth,r=this.pixelHeight;return n=r=e.scale,this.targetContext.canvas.width=n,this.targetContext.canvas.height=r,this.targetContext.drawImage(t,0,0,n,r),{sw:n,sh:r}},t.prototype.resizeAndFitTargetSize=function(t,e){var n=this.pixelWidth,r=this.pixelHeight,i=n,a=r;n<r?(i=e.scale,a=Math.round(i*r/n)):(a=e.scale,i=Math.round(a*n/r)),this.targetContext.canvas.width=i,this.targetContext.canvas.height=a;var s=e.targetSize.width,o=e.targetSize.height;this.targetContext.drawImage(t,0,0,i,a);var u=(i-s)/2,h=(a-o)/2;return i=s,a=o,this.getImageData(u,h,{sw:i,sh:a})},t.prototype.fitToTargetSize=function(t,e,n){var r=e.targetSize.width,i=e.targetSize.height;this.targetContext.canvas.width=r,this.targetContext.canvas.height=i,this.targetContext.fillStyle=e.gapFillWith,this.targetContext.fillRect(0,0,i,r);var a=r,s=i,o=0,u=0;return r/i*this.pixelHeight/this.pixelWidth>=1?(a=Math.round(s*this.pixelWidth/this.pixelHeight),o=Math.floor((r-a)/2)):(s=Math.round(a*this.pixelHeight/this.pixelWidth),u=Math.floor((i-s)/2)),n?this.targetContext.drawImage(t,o,u,a,s):this.targetContext.drawImage(t,0,0,a,s),{sw:r,sh:i}},t.prototype.getImageData=function(t,e,n){var r=n.sw,i=n.sh;return this.targetContext.getImageData(t,e,r,i)},t.prototype.grayscale=function(t){for(var e=t.data,n=0;n<e.length;n+=4){var r=(e[n]+e[n+1]+e[n+2])/3;e[n]=r,e[n+1]=r,e[n+2]=r}return e},t}();var W=function(t,e,n,r){return new(n||(n=Promise))((function(i,a){function s(t){try{u(r.next(t))}catch(t){a(t)}}function o(t){try{u(r.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,o)}u((r=r.apply(t,e||[])).next())}))},X=function(t,e){var n,r,i,a,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}};const B=function(){function t(t){this.modelConfig={},this.isPaused=!1,this.model={},this.weightMap=[],this.isExecuted=!1,this.test=!1,this.graphGenerator={},this.mediaProcessor=null,this.needPreheat=!0,this.modelConfig=Object.assign({fill:"#fff",scale:256},t),this.needPreheat=void 0===t.needPreheat||t.needPreheat,this.modelName=t.modelName||Date.now().toString(),this.weightMap=[],i.set("ns",p()),"node"!==i.get("platform")&&(this.mediaProcessor=new z)}return t.prototype.init=function(){return W(this,void 0,void 0,(function(){return X(this,(function(t){switch(t.label){case 0:return u.backendInstance?[4,u.backendInstance.init()]:(console.error("ERROR: Haven't register backend"),[2]);case 1:return t.sent(),this.isExecuted=!1,[4,this.load()];case 2:return t.sent(),this.genFeedData(),this.genGraph(),this.genOpData(),this.needPreheat?[4,this.preheat()]:[3,4];case 3:return[2,t.sent()];case 4:return[2]}}))}))},t.prototype.load=function(){return W(this,void 0,void 0,(function(){var t,e,n,r,i;return X(this,(function(s){switch(s.label){case 0:return t=this.modelConfig,e=t.modelPath,n=t.fileCount,r=new a(e,n),i=this,[4,r.load()];case 1:return i.model=s.sent(),[2]}}))}))},t.prototype.genGraph=function(){this.graphGenerator=new j(this.model,this.modelConfig.type,this.modelConfig.plugins),this.weightMap=this.graphGenerator.createGraph()},t.prototype.genOpData=function(){var t=this,e=0;this.weightMap.forEach((function(n,r){var i=n.type;if("feed"!==i&&"fetch"!==i){e++;var a=r===t.weightMap.length-2,s=new G(n,e,t.model.vars,a,t.modelName);n.opData=s}}))},t.prototype.preheat=function(){return W(this,void 0,void 0,(function(){var t;return X(this,(function(e){switch(e.label){case 0:return[4,this.checkModelLoaded()];case 1:return e.sent(),[4,this.execute()];case 2:return t=e.sent(),this.isExecuted=!0,[2,t]}}))}))},t.prototype.checkModelLoaded=function(){return W(this,void 0,void 0,(function(){return X(this,(function(t){switch(t.label){case 0:return 0!==this.weightMap.length?[3,2]:(console.info("It's better to preheat the model before running."),[4,this.load()]);case 1:t.sent(),this.genFeedData(),this.genGraph(),this.genOpData(),this.isExecuted=!1,t.label=2;case 2:return[2]}}))}))},t.prototype.predict=function(t,e){return W(this,void 0,void 0,(function(){var n,r;return X(this,(function(i){switch(i.label){case 0:return this.isPaused||!this.mediaProcessor?[2]:(n=this.mediaProcessor.process(t,this.modelConfig),this.updateFeedData(n),[4,this.execute()]);case 1:return r=i.sent(),this.isExecuted=!0,[2,e?e(r):r]}}))}))},t.prototype.predictWithFeed=function(t,e,n){var r;return W(this,void 0,void 0,(function(){var i,a,s,o,u,h,p,c,f;return X(this,(function(l){switch(l.label){case 0:return i=this.modelConfig.feedShape,a=i.fw,s=i.fh,Array.isArray(t)?(null===(r=t[0])||void 0===r?void 0:r.data)?((c=t[0].data)instanceof Float32Array||(t[0].data=new Float32Array(c)),o=t):o=[{data:new Float32Array(t),shape:n||[1,3,s,a],name:"image"}]:(h=(u=t).width,p=u.height,c=u.data,o=[{data:new Float32Array(c),shape:n||[1,3,p||s,h||a],name:"image"}]),this.updateFeedData(o),[4,this.execute()];case 1:return f=l.sent(),this.isExecuted=!0,[2,e?e(f):f]}}))}))},t.prototype.genFeedData=function(){var t,e,n=this.modelConfig,r=n.type,i=n.feedShape,a=i.fh,o=i.fw,u=this.model.vars;if(r===s.MultipleInput){var h=this.model.ops&&this.model.ops[0]&&(null===(t=this.model.ops[0].inputs)||void 0===t?void 0:t.X);h.length>1&&(e=h.map((function(t){var e=u.find((function(e){return e.name===t})),n=e.shape.reverse(),r=n[0],i=n[1],a=n[2],s=void 0===a?3:a,o=n[3],h=void 0===o?1:o;return e.data=new Float32Array(h*s*i*r),e})))}else{if(e=u.find((function(t){return"image"===t.name})))return void(e.data=new Float32Array(3*a*o).fill(1));e={data:new Float32Array(3*a*o).fill(1),name:"image",shape:[1,3,a,o]}}u.push(e)},t.prototype.updateFeedData=function(t){this.weightMap.find((function(t){return t.opData?t.opData.inputTensors.find((function(t){return t.tensorId.endsWith("_image")})):null})).opData.inputTensors.find((function(t){return t.tensorId.endsWith("_image")})).data=t[0].data},t.prototype.execute=function(){return W(this,void 0,void 0,(function(){var t,e,n,r;return X(this,(function(i){switch(i.label){case 0:return t=this.graphGenerator.getFeedExecutor(),this.executeOp(t),[4,this.read()];case 1:return e=i.sent(),(n=this.model.multiOutputs)?(r=0,[2,n.map((function(t){var n,i=A(t.shape),a=e.slice(r,i+r);return r+=i,(n={})[t.name]=a,n}))]):[2,e]}}))}))},t.prototype.executeOp=function(t){var e;if("fetch"!==t.type)if(t.execute(this.isExecuted),i.get("debug")&&(null===(e=t.opData)||void 0===e?void 0:e.outputTensors)&&t.opData.outputTensors[0]&&t.opData.outputTensors[0].tensorId===this.modelName+"_"+i.get("ns").layerName)console.info(t.opData.name+"_"+t.opData.iLayer,"runner op");else if(t.next){var n=t.next,r=this.graphGenerator.getExecutorById(n);this.executeOp(r)}},t.prototype.read=function(){return W(this,void 0,void 0,(function(){var t,e;return X(this,(function(n){switch(n.label){case 0:return t=this.graphGenerator.getFetchExecutor(),e=this.model.vars.find((function(e){return e.name===t.inputs.X[0]})),[4,u.backendInstance.read(e)];case 1:return[2,n.sent()]}}))}))},t.prototype.stopPredict=function(){this.isPaused=!0},t}(),H=function(){}},993:()=>{}},e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={exports:{}};return t[r](i,i.exports,n),i.exports}return n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n(180)})()}));